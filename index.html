<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Clothing Try-On</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1000px;
        }
        .border-dashed {
            border-style: dashed;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto bg-white rounded-3xl shadow-xl overflow-hidden p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">AI Clothing Try-On</h1>
        <p class="text-center text-gray-500 mb-8">Upload a person's image and a garment image to see the result.</p>

        <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6 justify-between">
            
            <div class="w-full md:w-1/2 flex flex-col items-center">
                <div class="bg-gray-50 rounded-xl p-4 w-full border-2 border-dashed border-gray-300 transition-colors duration-200 hover:border-blue-500">
                    <label for="personImage" class="cursor-pointer">
                        <div class="flex flex-col items-center justify-center h-64 text-center text-gray-400">
                            <span class="text-5xl mb-2">ðŸ‘¤</span>
                            <span id="personLabel" class="text-sm font-semibold">Step 1. Upload a person image</span>
                            <input type="file" id="personImage" accept="image/*" class="hidden" onchange="previewImage(event, 'personPreview', 'personLabel')">
                        </div>
                    </label>
                    <img id="personPreview" src="" alt="Person Preview" class="hidden w-full h-full object-cover rounded-xl mt-4">
                </div>
            </div>

            <div class="w-full md:w-1/2 flex flex-col items-center">
                <div class="bg-gray-50 rounded-xl p-4 w-full border-2 border-dashed border-gray-300 transition-colors duration-200 hover:border-blue-500">
                    <label for="garmentImage" class="cursor-pointer">
                        <div class="flex flex-col items-center justify-center h-64 text-center text-gray-400">
                            <span class="text-5xl mb-2">ðŸ‘•</span>
                            <span id="garmentLabel" class="text-sm font-semibold">Step 2. Upload a garment image</span>
                            <input type="file" id="garmentImage" accept="image/*" class="hidden" onchange="previewImage(event, 'garmentPreview', 'garmentLabel')">
                        </div>
                    </label>
                    <img id="garmentPreview" src="" alt="Garment Preview" class="hidden w-full h-full object-cover rounded-xl mt-4">
                </div>
            </div>

        </div>

        <div class="mt-8 flex flex-col items-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Step 3. Result</h2>
            <div id="resultContainer" class="bg-gray-50 rounded-xl p-4 w-full border-2 border-dashed border-gray-300 flex items-center justify-center h-96 overflow-hidden">
                <div id="loading" class="hidden loading-spinner"></div>
                <img id="resultImage" src="" alt="Try-On Result" class="hidden w-full h-full object-contain rounded-xl">
                <span id="resultPlaceholder" class="text-gray-400 text-center font-semibold">Your try-on result will appear here.</span>
            </div>

            <button id="runButton" class="mt-6 w-full md:w-auto px-10 py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105" onclick="runTryOn()">
                Run
            </button>
        </div>

    </div>

    <script>
        // Set your actual API key here. The provided key is a placeholder and will not work.
        const apiKey = "AIzaSyCPUcLAetY9m0yb4DxYWNyonB89unXdHeU";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

        // Function to preview selected image
        function previewImage(event, previewId, labelId) {
            const preview = document.getElementById(previewId);
            const label = document.getElementById(labelId);
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    label.textContent = file.name;
                    // Safely adjust height to show the preview
                    const containerDiv = document.getElementById(event.target.id).closest('div');
                    const targetDiv = containerDiv.querySelector('.h-64');
                    if (targetDiv) {
                        targetDiv.style.height = 'auto';
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // Function to convert an image file to a base64 string
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Extract base64 part only
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Function to run the AI try-on
        async function runTryOn() {
            // Check if the placeholder API key is being used
            if (apiKey === "YOUR_API_KEY_HERE" || apiKey.length < 20) {
                alert("Please replace the placeholder 'YOUR_API_KEY_HERE' with your actual Google Gemini API key in the script.");
                return;
            }
            
            const personImageFile = document.getElementById('personImage').files[0];
            const garmentImageFile = document.getElementById('garmentImage').files[0];

            const runButton = document.getElementById('runButton');
            const loading = document.getElementById('loading');
            const resultImage = document.getElementById('resultImage');
            const resultPlaceholder = document.getElementById('resultPlaceholder');
            
            // Clear previous results and messages
            resultImage.classList.add('hidden');
            resultPlaceholder.textContent = "";

            // Check if both images are uploaded
            if (!personImageFile || !garmentImageFile) {
                resultPlaceholder.textContent = 'Please upload both a person image and a garment image.';
                resultPlaceholder.classList.remove('hidden');
                return;
            }

            // Show loading spinner and hide button
            runButton.classList.add('hidden');
            loading.classList.remove('hidden');
            resultPlaceholder.classList.add('hidden');

            try {
                // Convert images to base64
                const personBase64 = await getBase64(personImageFile);
                const garmentBase64 = await getBase64(garmentImageFile);

                // Construct the prompt for the AI model
                const prompt = `Create a realistic image of the person wearing the garment. The person is in the first image, and the garment is in the second image. The final image should show the person in the same pose, but with the garment from the second image.`;

                // Build the payload for the API request
                const payload = {
                    contents: [
                        {
                            parts: [
                                {
                                    text: prompt
                                },
                                {
                                    inlineData: {
                                        mimeType: personImageFile.type,
                                        data: personBase64
                                    }
                                },
                                {
                                    inlineData: {
                                        mimeType: garmentImageFile.type,
                                        data: garmentBase64
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseModalities: ["TEXT", "IMAGE"]
                    }
                };
                
                // Fetch the response from the Gemini API with a retry mechanism
                let response;
                let retries = 0;
                const maxRetries = 5;
                const initialDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Success!
                        } else if (response.status === 429) {
                            // Too Many Requests, implement exponential backoff
                            retries++;
                            const delay = initialDelay * Math.pow(2, retries);
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                        } else {
                            throw new Error(`API returned status ${response.status}: ${await response.text()}`);
                        }
                    } catch (error) {
                        retries++;
                        const delay = initialDelay * Math.pow(2, retries);
                        console.error(`Fetch error: ${error.message}. Retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                    }
                }

                if (!response.ok) {
                    throw new Error("Failed to fetch from API after multiple retries.");
                }

                const result = await response.json();
                
                // Extract the base64 image data from the response
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    resultImage.src = imageUrl;
                    resultImage.classList.remove('hidden');
                } else {
                    resultPlaceholder.textContent = "Error: Failed to generate try-on image. The API response did not contain an image.";
                    resultPlaceholder.classList.remove('hidden');
                    console.error("API response did not contain an image.");
                }

            } catch (error) {
                console.error("An error occurred:", error);
                resultPlaceholder.textContent = "Error: An unexpected error occurred. Please check the browser console for details.";
                resultPlaceholder.classList.remove('hidden');
            } finally {
                // Hide loading spinner and show button
                loading.classList.add('hidden');
                runButton.classList.remove('hidden');
                // The `closest` method on `resultImage` will get the `resultContainer` div
                if (resultImage.closest('div')) {
                    resultImage.closest('div').style.height = 'auto';
                }
            }
        }
    </script>

</body>
</html>

